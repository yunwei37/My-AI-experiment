理解共享数据库中锁粒度与一致性等级：深入解析 Gray 等人 1975 年的开创性论文

1970 年代中期，数据库管理系统正经历着迅速演变。其中的核心挑战在于如何在确保数据一致性的同时最大化系统性能——这一微妙的平衡至今仍然十分关键。Gray、Lorie、Putzolu 和 Traiqer 等人在 1975 年发表的论文《共享数据库中的锁粒度及一致性等级》为这一领域做出了关键性贡献。这篇论文为现代数据库中的锁机制奠定了基础，并引入了许多持续影响数据库架构的重要概念。

核心问题：锁粒度

论文一开始便关注数据库管理中的一个基本问题：挑选可加锁对象的粒度（大小）。作者指出：

“锁定单位的选择呈现出并发性与开销之间的权衡，这种权衡与单位本身的大小或粒度有关。”

锁粒度指的是锁所应用的数据片段的大小，从粗粒度锁（例如整个文件）到细粒度锁（例如单个记录甚至记录中的特定字段）。所选粒度直接影响系统的并发性（即系统同时处理多个事务的能力）和管理锁所带来的计算与存储资源开销。

•	细粒度锁：有助于提高并发性，因为多个事务可以同时操作数据的不同部分。例如，对单个记录加锁可使两位用户在同一文件中编辑不同记录而不会产生冲突。

  “从一方面看，如果选择一个细小的锁定单位（例如记录或字段），并发性会提高。”

  但缺点在于，当事务需要访问大量记录时，细粒度锁可能会变得“成本高昂”。每一个单独的锁都会增加系统在计算和内存上的开销。

•	粗粒度锁：对于操作大数据块的复杂事务而言，这种锁管理起来更简单且带来较少的开销。

  “对于访问许多记录的事务来说，一个粗锁定单位（例如文件）可能更为方便。”

  然而，这种方便性是以降低并发为代价的，因为锁定资源会限制同时进行的事务数量。

作者总结认为，理想的锁系统应当能支持多种粒度的锁定，从而使系统在需要时既能享有高并发性又能保持低开销。

引入多模式锁定协议

为了解决上述权衡问题，Gray 及其团队提出了一种先进的锁定协议，该协议采用了多锁模式，不再局限于传统的共享（S）与独占（X）模式。论文中写道：

“提出了一种支持不同事务以不同粒度同时加锁的锁定协议。该协议在传统共享模式与独占模式之外引入了额外的锁模式。”

六种锁模式

该协议引入了六种不同的锁模式：

1. NL（无锁）：表示没有加锁。
2. IS（意向共享）：表示有意在下级节点上获取共享锁。
3. IX（意向独占）：表示有意在下级节点上获取独占锁。
4. S（共享）：允许读取被锁定资源，但禁止修改。
5. SIX（共享意向独占）：结合了读取资源的权限与对下级数据加锁以便修改的意向。
6. X（独占）：允许对资源进行读写，并阻止所有其他访问。

这些模式以层次结构组织，使事务能够在不同细节层面上加锁，同时维护整体数据一致性。其中，意向锁（IS 和 IX）尤为重要，它们有助于在分层结构中管理锁定，确保高层锁能够反映低层的锁定意向。

兼容性矩阵

不同锁模式之间的兼容性有所不同，正如所提出的兼容性矩阵所示：

•	S 与 S 模式之间是兼容的，从而允许多个事务同时读取同一数据。
•	X 模式与所有其他模式不兼容，确保在资源被写入时，其他事务既不能读取也不能写入。
•	IS 与 IX 模式可以彼此兼容，但在未作额外说明的情况下，它们与 S 或 X 模式通常不兼容。

这一兼容性矩阵确保了协议能应对多个事务以不同粒度同时操作同一数据时出现的复杂场景。

一致性等级

这篇论文的重要贡献之一在于它详细探讨了共享数据库环境中的一致性等级。作者认识到自动锁协议只能提供有限的保证，于是引入了四个一致性等级：

1. 等级 0：保护他人免受你的更新影响。
2. 等级 1：防止更新丢失。
3. 等级 2：防止读取错误的数据项。
4. 等级 3：确保全面保护，防止读取数据项之间的不正确关系。

论文进一步阐述道：

“等级 3 一致性完全隔离了事务免受因并发产生的不一致性影响，从而确保了数据的完全一致视图。”

这些等级为在多事务环境中理解和实现一致性提供了一种细致的框架，使数据库系统能够根据应用需求在性能与数据完整性之间取得平衡。

实施与实际应用

论文中构建的理论框架通过在实际数据库系统中开发锁定协议得以实现。作者讨论了其思想在比如 IMS/VS 和 DMS 1100 等系统中的实现，突显了在应用多模式锁定策略时面对的实际挑战和解决方案。

例如，IMS/VS 采用了一个两层锁定层次结构，支持段类型和段实例，与所提出的六模式协议高度契合：

“IMS/VS 结合程序隔离特性采用了两级锁定层次：段类型以及段类型内的段实例。”

这一实际应用验证了先进锁定协议在管理并发数据库事务方面的可行性与有效性，从而进一步证明了该论文理论贡献的正确性和持久影响。

反思与影响

1975 年发表的 Gray 等人的工作远见卓识，预见了数十年后数据库管理系统中许多核心挑战及相应解决方案。他们引入的多粒度锁定与一致性等级为后续在这一领域的研究与开发提供了坚实基础。

时至今日，锁粒度与一致性的概念依然是数据库设计中的核心。现代系统不断细化这些理念，实施更先进的锁定机制和一致性模型，以应对日益复杂和大规模的数据环境。

最后思考

《共享数据库中的锁粒度及一致性等级》不仅仅是一篇研究论文，更是数据库系统大厦中的基石。通过对锁粒度与数据一致性之间相互作用的细致探讨，Gray 及其同事为数据库设计师提供了构建既高效又可靠系统的重要工具。在当今数据密集型应用愈发复杂的背景下，回顾如此开创性的工作不仅能提供恒久的启示，也彰显了基础研究的持久价值。

了解更多请访问 <https://yunwei37.github.io/My-AI-experiment/> 或者 Github： <https://github.com/yunwei37/My-AI-experiment>
# ghOSt：通过用户空间委派革新 Linux 调度

在数据中心不断演变的格局中，资源管理的效率和灵活性至关重要。传统的内核调度器虽然功能强大，但也存在一些局限，这些局限会阻碍最佳性能、扩展性和安全性的实现。由 Google 和斯坦福大学的 Jack Tigar Humphries 等人提出的**ghOSt**，是一种开创性框架，其详细介绍发表于 2021 年的研究论文《ghOSt: Fast & Flexible User-Space Delegation of Linux Scheduling》。该论文在 ACM SIGOPS 第28届操作系统原理研讨会 (SOSP ‘21) 上发表，ghOSt 为 Linux 环境下的调度提供了一种变革性的新途径，旨在满足现代数据中心日益细化的需求。

## 理解核心问题

操作系统在管理应用程序如何使用 CPU 资源方面发挥着至关重要的作用。内核调度器作为一个基础组件，负责决定在任一时刻哪些线程在特定的 CPU 上运行。然而，随着数据中心工作负载的迅速增加和应用程序种类的多样化，内核调度器往往难以迅速、高效地适应这种变化。正如论文中所述：

“最近的研究表明，在定制数据平面操作系统中使用专门的调度策略可以在数据中心中提供令人信服的性能表现……然而，由于在应用粒度上部署定制操作系统映像是不切实际的，因此这一方法难以实现。”

这揭示了一个关键挑战：内核调度器的僵化性阻碍了针对特定工作负载或安全需求量身定制的高性能调度策略的部署。

## 介绍 ghOSt：用户空间调度器

**ghOSt**（读作 “ghost”）是一种创新性的基础设施，它旨在将内核调度决策委派给用户空间的进程。通过这种方式，调度逻辑与内核得以解耦，从而提供前所未有的灵活性和控制能力。作者在论文中对 ghOSt 的主要目标做了如下描述：

“ghOSt 在 Linux 环境中提供了通用的调度策略委派到用户空间进程……在应用之间隔离共享的处理器状态。”

在本质上，ghOSt 的工作机制是让用户空间代理基于线程和 CPU 当前的状态做出调度决策，然后指导内核如何执行。这种分离方案允许开发者无需修改内核本身，就能实现、测试和部署复杂的调度策略。

## 设计与实现：ghOSt 的工作原理

ghOSt 框架具备几项显著的特点，使其脱颖而出：

1. **状态封装与通信**：ghOSt 将调度状态进行封装，并通过基于事务的 API 高效地在内核与用户空间代理之间传递信息。
   
   “调度策略定义位于用户空间，ghOSt 必须允许新的策略能够被部署、更新、回滚，甚至在崩溃时也不会导致机器重启的代价。”

2. **调度模型**：它支持各种调度模型，包括每 CPU 独立调度和集中式调度。这种适应性确保 ghOSt 能够满足从简单负载均衡到复杂多租户感知策略的多样化调度需求。

3. **低开销**：ghOSt 的一大亮点在于其小巧的开销。论文中报告称：
   
   “ghOSt 的调度开销很小，从消息传递的 265 纳秒到调度决策端到端延迟 1,772 纳秒不等。”

   与传统内核调度器相比，这些数字尤为令人印象深刻，因为传统调度器在类似操作上往往存在更高的延迟和更长的处理时间。

4. **安全性提升**：通过将调度逻辑隔离到用户空间，ghOSt 降低了内核的攻击面，有效缓解了诸如 Spectre 和 Meltdown 之类的硬件漏洞风险。

## 评估 ghOSt：性能与可扩展性

作者通过大量评测将 ghOSt 与现有的调度器进行了对比，包括 Linux 完全公平调度器 (CFS) 及类似 Shinjuku 和 Shenango 等专用调度器。主要发现包括：

- **吞吐量与延迟**：ghOSt 在吞吐量上与 Shinjuku 匹敌，甚至在尾部延迟上取得了显著改善。例如，在多租户场景下，ghOSt 实现了 1.6 倍的吞吐量提升和 17 倍的请求尾部延迟降低。

- **可扩展性**：该框架展示了令人印象深刻的扩展能力，每秒处理超过 200 万个线程，确保即使数据中心工作负载不断增长，ghOSt 依然能够保持高效稳定。

- **策略实现的灵活性**：开发者仅需用几百行用户空间代码就能实现复杂的调度策略，而传统内核调度器的修改通常需要成千上万行代码。

## 实际应用与真实部署

ghOSt 并非仅仅是一个理论构想，而是面向实际应用而设计的。作者展示了其在 Google 生产环境中的部署实例，例如 Google Snap 和 Google Search。在这些场景中，ghOSt 实现了核心隔离策略的快速部署，隔离了不可信线程与共享处理器状态，以及在大规模服务器集群中实现了不间断的策略优化。

例如，在 **GoogleSnap** 工作负载中，ghOSt：

“使查询类型 A 和 B 的尾部延迟降低了约 40-45%，这一改善得益于确保每个物理核心只运行属于同一 CPU 的线程。”

这充分彰显了 ghOSt 在提升性能的同时，也兼顾了系统稳定性和安全性。

## 安全影响：超越性能

鉴于 L1TF/MDS 等近期硬件漏洞的出现，ghOSt 的设计在安全性上提供了显著优势。通过将调度逻辑隔离到用户空间，并确保不可信线程不会与关键线程共享处理器状态，ghOSt 本质上降低了此类攻击的风险面。

论文详细阐述道：

“通过使用 ghOSt 替代内核调度器，我们能够快速部署新的核心隔离策略，将应用之间的共享处理器状态隔离开……同时为数据中心工作负载实现策略优化和故障隔离。”

这种方法不仅强化了系统应对已知漏洞的能力，还提供了一个灵活的框架，使得在不修改内核的情况下也能适应新兴威胁。

## 与相关工作比较

ghOSt 之所以在同类技术中脱颖而出，是因为它在灵活性、性能和安全性上的独特结合。与 Shinjuku、Shenango 和 Caladan 等调度器相比，ghOSt 提供了：

- **更高的灵活性**：用户空间的委派让调度策略能够更加动态、便于更新。
- **更低的开销**：极低的延迟和高效的信息传递确保 ghOSt 不会成为系统性能的瓶颈。
- **增强的安全性**：用户空间的隔离符合现代安全理念，为防御内核级漏洞提供了坚实防线。

此外，ghOSt 开源了内核和用户空间组件，并在 GitHub 上公开，促进了社区协作和进一步创新。

## 未来方向与潜在改进

虽然 ghOSt 在 Linux 调度方面已经取得了重大突破，但该研究也为未来探索提供了新思路：

- **增强策略开发**：随着策略实现变得更加简便，社区可以开发并贡献出针对特定应用需求的全新调度策略。
- **与新兴硬件技术的整合**：随着硬件不断进化，ghOSt 能够适应新架构和加速器的应用，从而确保持续的性能提升。
- **超越数据中心的更广泛采用**：尽管 ghOSt 主要面向数据中心，但其优势同样适用于其他需要高扩展性和高性能的领域，如边缘计算和大规模科学计算。

## 结论

ghOSt 的推出标志着操作系统调度器设计的一个关键转折点。通过将调度决策委派到用户空间，ghOSt 针对内核调度器固有的局限性提出了有效解决方案，实现了性能、可扩展性和安全性的整体提升。在 Google 生产环境中的成功应用进一步证明了 ghOSt 的有效性，使其成为未来 Linux 系统调度创新的基石。

随着数据中心持续扩张以及应用对资源管理越来越细粒度和高效的需求，如 ghOSt 这样的框架将在应对现代计算基础设施复杂性方面发挥不可或缺的作用。

对于那些希望深入了解 ghOSt 实现细节及其贡献的人员，作者已慷慨开源了他们的工作：

- **内核代码**：[ghOSt Kernel Code](https://github.com/google/ghost-kernel)
- **用户空间代码**：[ghOSt Userspace Code](https://github.com/google/ghost-userspace)

拥抱这样的创新不仅为构建更高效的系统铺平道路，也促进了一个能够快速迭代和部署新进展的协作生态系统。

# 参考文献

- Humphries, J. T., Natu, N., Chaugule, A., Weisse, O., Rhoden, B., Don, J., ... & Kozyrakis, C. (2021). ghOSt: Fast & Flexible User-Space Delegation of Linux Scheduling. In **Proceedings of the ACM SIGOPS 28th Symposium on Operating Systems Principles (SOSP ’21)**.

> 了解更多请访问 <https://yunwei37.github.io/My-AI-experiment/> 或者 GitHub： <https://github.com/yunwei37/My-AI-experiment>